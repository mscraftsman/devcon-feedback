// generated by gocipe; DO NOT EDIT

package main

import (
	"flag"
	"fmt"
	"log"
	"net/http"
	"os"

	"github.com/mscraftsman/devcon-feedback/config"
	"github.com/mscraftsman/devcon-feedback/sessionize"
	"github.com/mscraftsman/devcon-feedback/store"

	"github.com/gorilla/handlers"
	"github.com/gorilla/mux"
	"github.com/mscraftsman/devcon-feedback/controllers"
	"github.com/mscraftsman/devcon-feedback/meetup"
)

// Version info
var (
	appVersion = "n/a"
	appCommit  = "n/a"
	appBuilt   = "n/a"
)

func main() {
	version := flag.Bool("v", false, "prints current app version")
	flag.Parse()
	if *version {
		fmt.Printf("Version: %s \nCommit: %s \nBuilt: %s", appVersion, appCommit, appBuilt)
		os.Exit(0)
	}

	config.Load()
	sessionize.LoadSessions()
	store.Init()

	allowedHeaders := handlers.AllowedHeaders([]string{"X-Requested-With"})
    allowedOrigins := handlers.AllowedOrigins([]string{"*"})
    allowedMethods := handlers.AllowedMethods([]string{"GET", "HEAD", "POST", "PUT", "DELETE", "OPTIONS"})

	router := mux.NewRouter()
	router.Path("login").Methods(http.MethodGet).HandlerFunc(meetup.Login)
	router.Path("meetup").Methods(http.MethodGet).HandlerFunc(meetup.LoginCallback)

	router.Path("/api/me").Methods(http.MethodGet).HandlerFunc(controllers.Me)
	router.Path("/api/bookmarks").Methods(http.MethodPost).HandlerFunc(controllers.AddBookmark)
	router.Path("/api/bookmarks").Methods(http.MethodGet).HandlerFunc(controllers.ListBookmarks)
	router.Path("/api/bookmarks/{id}").Methods(http.MethodDelete).HandlerFunc(controllers.RemoveBookmark)
	router.Path("/api/feedbacks").Methods(http.MethodPost).HandlerFunc(controllers.AddFeedback)
	router.Path("/api/feedbacks/me").Methods(http.MethodGet).HandlerFunc(controllers.ListOwnFeedback)

	log.Println("Listening on :" + config.HTTPPort)
	http.ListenAndServe(":"+config.HTTPPort, 
		handlers.CORS(allowedHeaders,allowedOrigins,allowedMethods)(router),
	)
}
